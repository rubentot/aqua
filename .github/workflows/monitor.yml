# AquaRegWatch Norway - GitHub Actions Workflow
# Serverless monitoring for Norwegian aquaculture regulations

name: Aquaculture Regulatory Monitor

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
    # Daily digest at 6 AM UTC (7 AM Oslo in winter, 8 AM in summer)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - digest
          - stats

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  EMAIL_FROM_ADDRESS: ${{ secrets.EMAIL_FROM_ADDRESS }}

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create data directories
        run: mkdir -p data/logs

      - name: Download previous database
        uses: dawidd6/action-download-artifact@v3
        with:
          name: aquaregwatch-db
          path: data/
          search_artifacts: true
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Run monitoring check
        run: python main.py --check
        if: github.event.inputs.action == 'check' || (github.event_name == 'schedule' && github.event.schedule == '0 * * * *')

      - name: Send daily digest
        run: python -m src.scheduler --digest
        if: github.event.inputs.action == 'digest' || (github.event_name == 'schedule' && github.event.schedule == '0 6 * * *')

      - name: Show statistics
        run: python main.py --stats
        if: github.event.inputs.action == 'stats'

      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        with:
          name: aquaregwatch-db
          path: data/aquaregwatch.db
          retention-days: 90
        if: always()

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}
          path: data/logs/
          retention-days: 7
        if: always()

  notify-failure:
    runs-on: ubuntu-latest
    needs: monitor
    if: failure()

    steps:
      - name: Send failure notification
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "⚠️ AquaRegWatch monitoring failed!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "⚠️ *AquaRegWatch Monitoring Failed*\n\nWorkflow: ${{ github.workflow }}\nRun: ${{ github.run_number }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''
